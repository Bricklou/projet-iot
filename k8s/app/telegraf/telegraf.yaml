---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: telegraf
spec:
  interval: 24h
  url: https://helm.influxdata.com/

---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: telegraf
spec:
  interval: 30m
  chart:
    spec:
      chart: telegraf
      version: 1.8.55
      sourceRef:
        kind: HelmRepository
        name: telegraf
  timeout: 5m
  releaseName: telegraf
  values:
    replicaCount: 2

    service:
      type : ClusterIP
    
    outputs:
      - influxdb:
        urls:
          - "http://localhost:8086"
        timeout: "5s"
        #token: "${INFLUXDB_TOKEN}"
        #organization: "${INFLUXDB_ORG}"
        #bucket: "${INFLUXDB_BUCKET}"
        user_agent: "telegraf"
        content_encoding: "gzip"
    
    inputs:
      - mqtt_consumer:
        servers: ["tcp:/rabbitmq:1883"]
        username: "RABBITMQ_USER"
        password: "RABBITMQ_PASSWORD"
        #topics: [
        #  "sensor/#",  # Example wildcard subscription
        #  "devices/+/temperature"  # Example with MQTT wildcards
        #]
        # Connection configurations
        #client_id: "telegraf_${HOSTNAME}"
        qos: 1
        connection_timeout: "30s"
        # Keep alive interval
        keep_alive: 30
        # Data format configuration
        data_format: "json"  # or "value", "influx" depending on your message format
        # JSON parsing configuration (adjust based on your message structure)
        #json_string_fields: ["field1", "field2"]
        json_time_key: "timestamp"
        json_time_format: "unix"
        #json_tag_keys: ["device_id", "location"]
        #json_measurement_key: "measurement_name"
        # Optional: persist sessions
        persistent_session: true
        # Optional: Will message configuration
        retained_message_path: "/tmp/retained_messages"

# Reference multiple external secrets
envFromSecrets:
  # RabbitMQ secrets
  - secretName: rabbitmq-secrets
    secretNamespace: rabbitmq  # Specify the namespace if different
    mapping:
      # Map the external secret keys to the environment variables Telegraf expects
      #MQTT_USER: "rabbitmq-user"
      MQTT_PASSWORD: "ADMIN_PASSWORD"
  
  # InfluxDB secrets
 # - secretName: influxdb-secrets
  #  secretNamespace: influxdb  # Specify the namespace if different
   # mapping:
    #  INFLUXDB_TOKEN: "influxdb-token"
     # INFLUXDB_ORG: "influxdb-org"
      #INFLUXDB_BUCKET: "influxdb-bucket"
